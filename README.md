# ui5-typescript-control-library - a Sample UI5 Library Developed in TypeScript

This repository demonstrates how to develop UI5 control libraries in TypeScript.

## Table of Contents

  * [Description](#description)
  * [Requirements](#requirements)
  * [Installation / Setup](#installation---setup)
  * [Usage](#usage)
  * [Things to Consider When Developing Control Libraries in TypeScript](#things-to-consider-when-developing-control-libraries-in-typescript)
    + [TypeScript Transpilation](#typescript-transpilation)
    + [tsconfig.json](#tsconfigjson)
    + [ui5.yaml](#ui5yaml)
    + [Control Implementation](#control-implementation)
    + [library.ts](#libraryts)
    + [ESLint](#eslint)
    + [Tests](#tests)
  * [Status](#status)
  * [Known Issues](#known-issues)
  * [How to obtain support](#how-to-obtain-support)
  * [Contributing](#contributing)
  * [Credits](#credits)
  * [License](#license)

## Description

This is an example UI5 control library, implemented in TypeScript, including tests, theme CSS files, a sample page for trying the control(s), and the entire needed tool setup including TypeScript transpilation, UI5 build, code linting etc.
The starting point of this library was generated with [generator-ui5-library](https://github.com/geert-janklaps/generator-ui5-library) and then manually converted to TypeScript.

## Requirements

* git client, Node.js

## Installation / Setup

```sh
git clone https://github.com/SAP-samples/ui5-typescript-control-library.git
cd ui5-typescript-control-library
npm i
```

## Usage

Start the control sample page in watch mode:

```sh
npm run watch
```

This opens the example control sample page in a browser window and launches the project in watch mode, which triggers several things at once whenever any code has changed:
* A re-generation of the TypeScript interfaces for the controls(so TypeScript knows all the generated control methods)
* A transpilation of the TypeScript code to JavaScript
* A reload of the page displayed in the browser

This is the mode in which you can best develop the controls within this library when doing changes to the control metadata or creating new controls.<br>
When the control APIs remain stable, you can also use `npm start` instead, which is almost equal, but skips the TypeScript interface generation.

<b>NOTE:</b> as mentioned above, while you extend/change the API of your control(s), TypeScript needs to be made aware of the methods generated by the UI5 framework at runtime (like `getText()` and `setText(...)` for a `text` property). This happens using the npm package [@ui5/ts-interface-generator](https://github.com/SAP/ui5-typescript/tree/main/packages/ts-interface-generator) (see link for details). This generator runs whenever a file is saved and creates a `*.generated.tsinterface.ts` file with the needed declarations next to each control file. So when TypeScript does not seem to know control API accessor methods, save the file and this problem should be gone. Those generated files will be overwritten and may be deleted automatically by the generator, so do not bother to change them.

<b>Also NOTE:</b> developing a control library in TypeScript comes with a few peculiarities, so please read the respective section below.

## Things to Consider When Developing Control Libraries in TypeScript

This section walks you through noteworthy points which are different or special in comparison to standard JavaScript development.

Topics like the themes/CSS and the translation texts are not different at all and hence not explained here. The choice to use Karma for testing and the test setup are coming from the underlying [library template](https://github.com/geert-janklaps/generator-ui5-library) and hence also not explained here.


### TypeScript Transpilation

In general, the TypeScript transpilation is set up as explained in the [step-by-step description](https://github.com/SAP-samples/ui5-typescript-helloworld/blob/main/step-by-step.md) in the Hello World application project, using Babel and the "babel-preset-transform-ui5", configured in the files `.babelrc.json` and `tsconfig.json`.

In `package.json`, the actual TypeScript transpilation is triggered, e.g. in the `build:ts` script:

```sh
babel src --out-dir src-gen --extensions \".ts,.js\" --copy-files --include-dotfiles
```

The `--include-dotfiles` option is important to get the `.library` file copied over. The test resources are transpiled separately, as they have a different target directory.

### tsconfig.json

In `tsconfig.json`, the `src` and `test` folders are configured to be the source folders. (`src-gen` is configured as output folder, but this configuration setting is not used during normal transpilation, where the output location is directly set in the respective Babel calls in `package.json`).

To make references using the library name work, a path mapping is configured, which points to the respective path below the `src` folder:
```
"paths": {
	"com/myorg/myUI5Library/*": [
		"./src/com/myorg/myUI5Library/*"
	]
}
```


### ui5.yaml

Usually the JavaScript library sources are inside the `src` folder and served from there by the UI5 tooling. Now the TypeScript sources are inside this folder and transpiled to the `src-gen` folder. The same is the case for `test` (transpiled to `test-gen`). To serve the correct JavaScript resources, the `ui5.yaml` file contains the following section:
```yaml
resources:
  configuration:
    paths:
      src: src-gen
      test: test-gen
```
The livereload middleware for watch mode is also configured to work on these directories.


### Control Implementation

General aspects of control development in TypeScript are also explained in the [`custom-controls` branch of the "Hello World" repository](https://github.com/SAP-samples/ui5-typescript-helloworld/tree/custom-controls).

As explained there, an additional named export of the control must be added to let the generated interface with all the API accessor methods be merged by TypeScript:
```ts
export { Example };
```
And one needs to manually copy the constructor signatures from the terminal output of the interface generator into the control implementation:
```ts
// The following three lines were generated and should remain as-is to make TypeScript aware of the constructor signatures
constructor(id?: string | $ExampleSettings);
constructor(id?: string, settings?: $ExampleSettings);
constructor(id?: string, settings?: $ExampleSettings) { super(id, settings); }
```

As also explained in that other project, the namespace of the control needs to be defined. In contrast to there, now an `@name` JSDoc tag with the *full* name is used:
```
@name com.myorg.myUI5Library.Example
```

Also in contrast to the custom control in that other project, the Renderer is implemented in a separate file, like it is typically done in the original UI5 libraries. But both options are equally valid. 

This is not specific to TypeScript, but may also not be known: at the beginning of the file, there is a `${copyright}` placeholder. When you don't remove it, it will be replaced in the UI5 build with content from the `. library` file.


### library.ts

In the `library.ts` file there is one thing specific to TypeScript: in UI5 Libraries, enums are directly appended to the global namespace of the library. This is actually required by the UI5  runtime to find the enum type when used for control properties.

The same is also done here, but as the global object is not known by TypeScript, the object is first acquired using the [`ObjectPath` API](https://openui5.hana.ondemand.com/api/module:sap/base/util/ObjectPath#methods/sap/base/util/ObjectPath.get):
```js
const thisLib = ObjectPath.get("com.myorg.myUI5Library");
```
Then the enum is attached to this object:
```js
thisLib.ExampleColor = ExampleColor;
```

This is important to be done for all enums. Most things will still seem to work when not doing it, but when the enum is used as type for a control property, UI5 will not be able to find the type (the console will show this as an issue!) and then stop type checking for this property.<br>
This is not intuitive and quite easy to forget, therefore it is intended to get the UI5 transformer modified to do this automatically. 

When the `${version}` placeholder is used, it is replaced with the version from the .library file.

### ESLint

TypeScript code linting is configured for this repository, using the "eslint", "@typescript-eslint/eslint-plugin" and "@typescript-eslint/parser" npm packages and the `eslintrc.json` file. It is triggered using the npm `lint` script.

### Tests

The `test` directory contains a QUnit-based unit test setup. There is actually nothing TypeScript-specific in that area, but one thing to note:<br>
The project uses private APIs in the testing area, e.g. resources/sap/ui/test/starter/createSuite.js. This is because the underlying template does so and is planned to be replaced by a cleaner solution.

## Status

WORK IN PROGRESS!


## Known Issues

There are multiple limitations, including:
* The project uses private APIs in the testing area, e.g. `resources/sap/ui/test/starter/createSuite.js`. This is because the underlying template does so and only some of the private API usages have been removed so far.

## How to obtain support

This project is provided as-is, without any support guarantees.

However, you are encouraged to [create an issue](https://github.com/SAP-samples/ui5-typescript-control-library/issues) in this repository if you find a bug or have have an improvement suggestion.

## Contributing

If you wish to contribute code, offer fixes or improvements, please send a pull request. Due to legal reasons, contributors will be asked to accept a DCO when they create the first pull request to this project. This happens in an automated fashion during the submission process. SAP uses [the standard DCO text of the Linux Foundation](https://developercertificate.org/).

## Credits

This project has been generated with ðŸ’™ and [generator-ui5-library](https://github.com/geert-janklaps/generator-ui5-library) and then adapted to TypeScript.

## License
Copyright (c) 2021 SAP SE or an SAP affiliate company. All rights reserved. This project is licensed under the Apache Software License, version 2.0 except as noted otherwise in the [LICENSE](LICENSES/Apache-2.0.txt) file.
